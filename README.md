# bv_tcp_file_transfer
Передача файлов по TCP с многопоточным промежуточным буфером на C++11

# Передача файлов по TCP с многопоточным промежуточным буфером

## Обзор

Данный проект реализует систему передачи файлов с использованием TCP сокетов на C++11. Решение создает пару TCP сокетов на localhost – один предназначен исключительно для отправки данных (send), а другой – исключительно для приема (recv). Отправитель открывает исходный файл, считывает его содержимое в большой буфер, а затем данные порционно передаются через промежуточный буфер меньшего размера. Приемник принимает данные через свой сокет и сохраняет их в другой файл. По завершении передачи происходит сравнение исходного и полученного файлов для проверки целостности данных.

## Особенности

- **Кроссплатформенность:** Работает как на Windows, так и на Linux.
- **Многопоточность:** Работа с файлами и сокетами осуществляется в отдельных потоках.
- **Промежуточный буфер с событийным пробуждением:** Буфер имеет встроенную поддержку условных переменных, позволяющих потокам эффективно ждать заполнения или опустошения буфера.
- **TCP сокеты:** Использование TCP обеспечивает надежную передачу данных.
- **Проверка целостности файлов:** После передачи исходный и полученный файлы сравниваются поблочно для подтверждения корректности передачи.
- **Модульная объектно-ориентированная модель:** Проект построен на базе классов с четким разделением обязанностей:
  - **Logger:** Потокобезопасный синглтон для ведения логирования.
  - **Buffer, Chunk, Pool:** Шаблонные и специализированные классы для потокобезопасного буферирования данных с поддержкой событийного пробуждения.
  - **Worker и Task:** Абстрактный базовый класс и его наследники для реализации операций чтения/записи файлов в отдельных потоках.
  - **TCPServer и TCPClient:** Классы, инкапсулирующие низкоуровневые операции с TCP сокетами.
  - **FileReader/FileWriter:** Классы для работы с файлами – чтения и записи.
  - **FISocket и FOSocket:** Классы для приема и передачи файлов по TCP.

## Структура проекта

- **Logger:**  
  Предоставляет потокобезопасное логирование с использованием паттерна синглтон. Макросы логирования (например, `tcpft_logInfo`) добавляют контекст (имя функции, уровень логирования).

- **Buffer, Chunk, Pool:**  
  - `Buffer<T, Size>` – универсальный потокобезопасный буфер с поддержкой условных переменных для ожидания.
  - `Chunk` – специализация `Buffer` для работы с фиксированным блоком символов.
  - `Pool` – буфер, содержащий объекты типа `Chunk`. Метод `Fit()` разбивает входную строку на чанки и помещает их в пул.

- **Worker и Task:**  
  Абстрактный класс `Worker` определяет интерфейс для всех рабочих потоков. Наследники (например, `FileReaderWorker` и `FileWriterWorker`) реализуют операции ввода-вывода с файлами. Класс `Task` оборачивает экземпляр рабочего класса для запуска в отдельном потоке.

- **TCPServer и TCPClient:**  
  Инкапсулируют операции работы с TCP сокетами. Сервер слушает входящие соединения, а клиент подключается к серверу (работают на localhost). Включают методы отправки и приема данных с поддержкой таймаута.

- **FileReader и FileWriter:**  
  Обеспечивают работу с файлами. `FileReader` считывает весь файл в строку, а `FileWriter` записывает данные в файл. Используются соответствующими рабочими классами.

- **FISocket и FOSocket:**  
  - `FISocket` (File Input Socket) отвечает за прием TCP соединения и запись принятых данных в выходной файл.
  - `FOSocket` (File Output Socket) подключается к серверу, считывает данные из файла с помощью `FileReaderWorker` и передает их по TCP.

- **Основное приложение:**  
  Функция `main()` запускает отдельные потоки для отправителя и приемника, осуществляет передачу файла, а затем сравнивает исходный и полученный файлы для проверки корректности передачи.

## Как это работает

1. **Чтение файла (Сторона отправителя):**
   - `FileReaderWorker` открывает исходный файл и считывает его содержимое в большой буфер.
   - Данные разбиваются на фиксированные чанки с помощью метода `Pool::Fit()`.
   - В конец данных добавляется специальный терминальный чанк (с символом `'\0'`), сигнализирующий об окончании файла.
   - Чанки помещаются во вспомогательный пул.

2. **Передача данных:**
   - Поток отправителя с помощью `TCPClient` подключается к TCP серверу, запущенному на localhost.
   - Данные из пула отправляются порционно через сокет.

3. **Запись файла (Сторона приемника):**
   - Поток приемника запускает TCP сервер (`TCPServer`), который слушает входящие соединения.
   - После принятия соединения данные считываются и помещаются в собственный пул.
   - `FileWriterWorker` непрерывно извлекает чанки из пула и записывает их в выходной файл.
   - Передача завершается при обнаружении терминального чанка.

4. **Проверка целостности:**
   - После завершения работы потоков исходный и полученный файлы сравниваются блочно.
   - Сравнение гарантирует, что данные переданы без ошибок.

## Требования

- **Компилятор:** C++11 (или выше).
- **ОС:** Windows и Linux.
- **Библиотеки:** Стандартная библиотека C++11, Winsock2 для Windows.

## TODO

1. Расширенная обработка ошибок:
   - Добавить более детальную обработку ошибок для работы с файлами и сокетами (например, логирование ошибок с указанием кода ошибки).

2. Параметризация буферов:
   - Сделать размеры буфера и чанков настраиваемыми через конфигурационный файл или параметры командной строки.

3. Юнит-тестирование:
   - Разработать набор модульных тестов для проверки работы ключевых компонентов (Logger, Buffer, FileReader/FileWriter, TCPClient/TCPServer).

4. Логирование в файл:
   - Добавить возможность логирования в файл, а не только в консоль, с разными уровнями логирования.

6. Улучшение синхронизации потоков:
   - Провести ревизию и, при необходимости, оптимизировать использование мьютексов и условных переменных для повышения производительности.
